name: CI Build

on:
  pull_request:
  push:
    branches:
      - main
      - develop

jobs:
  pr-title-enforcement:
    runs-on: ubuntu-latest

    steps:
      - name: Check PR title
        run: |
          if [[ ! ${{ github.event.pull_request.title }} =~ (feature|bug): ]]; then
            echo "PR title does not follow the required convention. It must start with 'fix:', 'feature:', or 'chore:'."
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN}}

  lint-and-unit-test:
    needs: [pr-title-enforcement]
    name: Lint & Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4

      - name: Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4
        with:
          node-version: 20
          cache: 'yarn'

      - name: Install dependencies
        run: |
          sudo apt-get install libgconf-2-4
          yarn --immutable

      - name: Run linting
        run: yarn lint

      - name: Run unit tests
        run: yarn test

      - name: Upload coverage reports to Codecov
        if: success()
        uses: codecov/codecov-action@e28ff129e5465c2c0dcc6f003fc735cb6ae0c673 # v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  e2e-tests:
    needs: [pr-title-enforcement]
    name: End-to-End (with mock data) Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4

      - name: Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4
        with:
          node-version: 20
          cache: 'yarn'

      - name: Install dependencies
        run: |
          sudo apt-get install libgconf-2-4
          yarn --immutable

      - name: Run e2e tests
        run: yarn e2e

      - name: Upload Cypress screenshots
        if: failure()
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4
        with:
          name: Inventory management system Screenshots
          path: cypress/screenshots

  e2e-tests-api:
    needs: [pr-title-enforcement]
    name: End-to-End (with api) Tests
    runs-on: ubuntu-latest

    steps:
      - name: Clone api repo
        uses: actions/checkout@9a9194f87191a7e9055e3e9b95b8cfb13023bb08
        with:
          repository: ral-facilities/inventory-management-system-api
          ref: develop

      - name: Set up Python
        uses: actions/setup-python@39cd14951b08e74b54015e9e001cdefcf80e669f # v5.1.1
        with:
          python-version: '3.12'

      # This is required as need to setup api in a different directory as checkout will attempt delete
      # all existing files which in this case will include a data directory created by docker causing
      # a permission error (checkout action also can't specify a different directory to clone into)
      - name: Move api repo
        run: |
          cd ..
          mkdir inventory-management-system-api
          mv -v inventory-management-system/* inventory-management-system-api/
          cd inventory-management-system-api/

      - name: Setup MongoDB
        working-directory: ../inventory-management-system-api
        run: |
          python ./scripts/dev_cli.py --ci db-init --replicaSetMemberHost localhost

      # Use docker run here to test the actual built image
      # Use same network as the MongoDB instance (which is generated by docker compose based on the folder
      # name)
      - name: Start inventory-management-system-api
        run: |
          docker run -d --network=host \
          --name inventory_management_system_api_container \
          --env AUTHENTICATION__ENABLED=false \
          --env API__TITLE="Inventory Management System API" \
          --env API__DESCRIPTION="This is the API for the Inventory Management System" \
          --env DATABASE__PROTOCOL="mongodb" \
          --env DATABASE__USERNAME="root" \
          --env DATABASE__PASSWORD="example" \
          --env DATABASE__HOST_AND_OPTIONS="localhost:27017/?authMechanism=SCRAM-SHA-256&authSource=admin" \
          --env DATABASE__NAME="ims" \
          --env API__ALLOWED_CORS_HEADERS='["*"]' \
          --env API__ALLOWED_CORS_ORIGINS='["*"]' \
          --env API__ALLOWED_CORS_METHODS='["*"]' \
          harbor.stfc.ac.uk/inventory-management-system/ims-api:develop

      - name: Checkout repo
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4

      - name: Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4
        with:
          node-version: 20
          cache: 'yarn'

      - name: Install dependencies
        run: |
          sudo apt-get install libgconf-2-4
          yarn --immutable

      - name: Run e2e tests
        run: yarn e2e:api

      - name: Output docker logs (mongodb)
        if: failure()
        run: docker logs mongodb_container

      - name: Output docker logs (api)
        if: failure()
        run: docker logs inventory_management_system_api_container

      - name: Upload Cypress screenshots
        if: failure()
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4
        with:
          name: Inventory management system (with api) Screenshots
          path: cypress/screenshots

  docker:
    # This job triggers only if all the other jobs succeed. It builds the Docker image and if successful,
    # it pushes it to Harbor.
    needs: [lint-and-unit-test, e2e-tests, e2e-tests-api]
    name: Docker
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Login to Harbor
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
        with:
          registry: ${{ secrets.HARBOR_URL }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@8e5442c4ef9f78752691e2d8f8d19755c6f78e81 # v5.5.1
        with:
          images: ${{ secrets.HARBOR_URL }}/ims

      - name: Build and push Docker image to Harbor
        uses: docker/build-push-action@16ebe778df0e7752d2cfcbd924afdbbd89c1a755 # v6.6.1
        with:
          context: .
          file: ./Dockerfile.prod
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
